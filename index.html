<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>INOVA ‚Äì Measurement (Web)</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0B6DB7">

  <style>
    :root{
      --bg:#f4f7fb;
      --panel:#ffffff;
      --primary:#0B6DB7;
      --primary-600:#095a98;
      --danger:#e57373;
      --muted:#e9eef6;
      --text:#0f172a;
      --text-weak:#475569;
      --ok:#16a34a;
      --nok:#dc2626;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
    }
    .container{
      max-width:1100px;
      margin-inline:auto;
      padding:18px;
    }
    .card{
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow: 0 1px 3px rgba(2,6,23,.08), 0 8px 24px rgba(2,6,23,.06);
      padding:18px;
    }
    header.hero{
      text-align:center;
      padding:28px 18px;
    }
    header.hero .logo{
      font-size:64px;
      line-height:1;
    }
    .title{
      margin:6px 0 2px;
      font-weight:800;
      font-size:clamp(26px,3.2vw,38px);
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--text-weak);
      margin:0 0 24px;
      font-weight:600;
    }
    .btn{
      appearance:none;border:0;cursor:pointer;
      background:var(--primary);color:#fff;
      border-radius:12px;padding:14px 20px;
      font-weight:700;box-shadow:inset 0 -2px 0 rgba(0,0,0,.08);
      transition:.18s ease;
    }
    .btn:hover{background:var(--primary-600)}
    .btn.muted{background:#90a4ae}
    .btn.light{
      background:#e6eef7;color:#0b3b6d;font-weight:700;
    }
    .btn.danger{background:var(--danger)}
    .btn-row{display:flex;gap:12px;flex-wrap:wrap}
    .grid-2{
      display:grid;gap:14px;
      grid-template-columns:1fr;
    }
    .panel-title{font-size:20px;font-weight:800;margin:0 0 10px}
    label{font-size:14px;font-weight:700;color:#0b3b6d;display:block;margin-bottom:6px}
    .req{color:#64748b;font-weight:800;margin-left:6px}
    input,textarea,select{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid #d0d7e2;
      background:#fff;outline:0;font-size:16px
    }
    textarea{min-height:110px;resize:vertical}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      font-weight:800;border-radius:999px;padding:8px 12px;font-size:14px
    }
    .badge.ok{color:#065f46;background:#d1fae5}
    .badge.nok{color:#7f1d1d;background:#fee2e2}

    /* ========= LAYOUT DA TELA 2 ========= */
    .layout-measure{
      display:grid;gap:16px;
      grid-template-columns:1fr;
    }
    .measure-box .big{
      font-weight:900;font-size:46px;letter-spacing:.5px;margin:8px 0 6px
    }

    /* ====== LANDSCAPE / TELAS LARGAS ====== */
    @media (min-width: 900px){
      .layout-measure{grid-template-columns:1fr 1fr}
    }

    /* grade de configura√ß√£o */
    .cfg-grid{
      display:grid;gap:12px;
      grid-template-columns:1fr;
    }
    /* portrait mant√©m tudo empilhado */

    /* landscape: ‚Äúdimens√£o nominal‚Äù full-row; tol sup + tol inf lado a lado */
    @media (min-width: 900px) and (orientation: landscape){
      .cfg-grid{
        grid-template-columns: 1fr 1fr;
      }
      .cfg-full{grid-column:1 / -1;}      /* linha inteira */
      .cfg-half{grid-column:auto;}        /* metade (duas colunas) */
    }

    /* tabela simples */
    table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    thead th{background:#eef3f9;font-size:14px;padding:10px 8px;text-align:left}
    tbody td{border-top:1px solid #e8edf6;padding:10px 8px;font-size:15px}
    .footer{
      display:flex;justify-content:space-between;align-items:center;
      color:#6b7280;margin-top:26px;font-size:14px
    }
    .version{font-weight:800;color:#94a3b8}
    .link{color:#0B6DB7;text-decoration:none;font-weight:700}
    .hidden{display:none !important}
  </style>
</head>
<body>

  <div id="screen-home" class="container">
    <header class="hero card">
      <div class="logo">üóíÔ∏è</div>
      <div class="title">INOVA- Measurement</div>
      <p class="subtitle">Web</p>
      <button id="go-measure" class="btn" type="button">Medi√ß√£o</button>
      <div class="footer">
        <span>Desenvolvido por INOVA Controle¬Æ</span>
        <span class="version">v1.0.0</span>
      </div>
    </header>
  </div>

  <div id="screen-measure" class="container hidden">
    <h2 class="panel-title">Medi√ß√£o (Sess√£o atual)</h2>

    <div class="layout-measure">
      <!-- LADO DIREITO EM TELAS LARGAS: MEDI√á√ÉO -->
      <section class="card measure-box">
        <h3 class="panel-title">Medi√ß√£o realizada</h3>
        <!-- IMPORTANTE: sem submit autom√°tico -->
        <div id="measure-form-wrapper">
          <input id="measure-input" inputmode="decimal" autocomplete="off" placeholder="Digite o valor e pressione Enter">
          <div class="btn-row" style="margin-top:10px">
            <button id="btn-save" class="btn" type="button">Salvar</button>
            <button id="btn-cancel" class="btn danger" type="button">Anular</button>
          </div>
        </div>

        <div class="big" id="last-value">‚Äì</div>
        <span id="result-badge" class="badge" aria-live="polite">Aguardando in√≠cio da medi√ß√£o</span>
      </section>

      <!-- LADO ESQUERDO EM TELAS LARGAS: GR√ÅFICO -->
      <section class="card">
        <h3 class="panel-title">Gr√°fico de medi√ß√µes</h3>
        <div style="height:220px;background:linear-gradient(#fff,#fff) padding-box, repeating-linear-gradient(0deg,transparent,transparent 39px,#d9e2ef 40px) border-box;border:12px solid transparent;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#94a3b8;">
          <small>Seu gr√°fico permanece como est√° (sem altera√ß√µes de c√≥digo aqui)</small>
        </div>
      </section>
    </div>

    <!-- CONFIGURA√á√ÉO -->
    <section class="card" style="margin-top:16px">
      <h3 class="panel-title">Configura√ß√£o</h3>

      <!-- grade responsiva:
           - .cfg-full = ocupa a linha inteira (usado para ‚Äúdimens√£o nominal‚Äù em landscape)
           - .cfg-half = metade (duas colunas) em landscape
           - em portrait, tudo empilhado (1 coluna) -->
      <div class="cfg-grid">
        <!-- FULL ROW EM LANDSCAPE -->
        <div class="cfg-full">
          <label for="f-nominal">Dimens√£o nominal <span class="req">*</span></label>
          <input id="f-nominal" placeholder="Ex.: 28">
        </div>

        <!-- DUAS COLUNAS EM LANDSCAPE -->
        <div class="cfg-half">
          <label for="f-tol-plus">Toler√¢ncia superior <span class="req">*</span></label>
          <input id="f-tol-plus" placeholder="Ex.: 0,2">
        </div>
        <div class="cfg-half">
          <label for="f-tol-minus">Toler√¢ncia inferior <span class="req">*</span></label>
          <input id="f-tol-minus" placeholder="Ex.: -0,2">
        </div>

        <div>
          <label for="f-upper">Limite superior</label>
          <input id="f-upper" disabled>
        </div>
        <div>
          <label for="f-lower">Limite inferior</label>
          <input id="f-lower" disabled>
        </div>

        <div>
          <label for="f-piece">Nome da pe√ßa <span class="req">*</span></label>
          <input id="f-piece" placeholder="Ex.: BUCHA">
        </div>
        <div>
          <label for="f-code">C√≥digo <span class="req">*</span></label>
          <input id="f-code" placeholder="Ex.: 1452-25">
        </div>

        <div>
          <label for="f-operator">Operador (opcional)</label>
          <input id="f-operator" placeholder="Ex.: Saulo">
        </div>
        <div>
          <label for="f-shift">Turno (opcional)</label>
          <input id="f-shift" placeholder="Ex.: 1, 2, 3">
        </div>
      </div>

      <div class="btn-row" style="margin-top:12px">
        <button id="btn-start" class="btn" type="button">Iniciar</button>
        <button id="btn-clear" class="btn light" type="button">Limpar</button>
        <button id="btn-history" class="btn light" type="button">Ver valores</button>
      </div>

      <div style="margin-top:12px">
        <label for="f-notes">Observa√ß√µes (opcional)</label>
        <textarea id="f-notes" placeholder="Anote aqui informa√ß√µes relevantes desta sess√£o"></textarea>
      </div>
    </section>

    <div class="footer">
      <a href="#" id="back-home" class="link">Voltar √† tela inicial</a>
      <span class="version">v1.0.0</span>
    </div>
  </div>

  <div id="screen-history" class="container hidden">
    <section class="card">
      <h2 class="panel-title">Hist√≥rico Global & Exporta√ß√£o</h2>
      <div class="btn-row" style="margin-bottom:10px">
        <button id="btn-pin" class="btn light" type="button">Definir/Alterar PIN</button>
        <button id="btn-export" class="btn" type="button">Exportar CSV</button>
        <button id="btn-clear-all" class="btn danger" type="button">Limpar hist√≥rico local</button>
      </div>

      <div style="overflow:auto;border-radius:12px;border:1px solid #e3eaf3">
        <table id="history-table">
          <thead>
            <tr>
              <th>N¬∫ Global</th>
              <th>Data</th>
              <th>Sess√£o_ID</th>
              <th>Pe√ßa</th>
              <th>C√≥digo</th>
              <th>Operador</th>
              <th>Turno</th>
              <th>Nominal</th>
              <th>Tol. +</th>
              <th>Tol. ‚àí</th>
              <th>Valor</th>
              <th>Resultado</th>
            </tr>
          </thead>
          <tbody><!-- preenchido via JS --></tbody>
        </table>
      </div>

      <div class="footer">
        <button id="back-measure" class="btn light" type="button">Voltar √† Medi√ß√£o</button>
        <span class="version">v1.0.0</span>
      </div>
    </section>
  </div>

  <script>
    // ========= helpers =========
    const $ = sel => document.querySelector(sel);
    const show = (id) => { $('#screen-home').classList.add('hidden'); $('#screen-measure').classList.add('hidden'); $('#screen-history').classList.add('hidden'); document.getElementById(id).classList.remove('hidden'); };

    // ========= navega√ß√£o b√°sica =========
    $('#go-measure').addEventListener('click',()=>show('screen-measure'));
    $('#back-home').addEventListener('click',(e)=>{e.preventDefault();show('screen-home');});
    $('#btn-history').addEventListener('click',()=>{ show('screen-history'); renderHistory(); });
    $('#back-measure').addEventListener('click',()=>show('screen-measure'));

    // ========= campos principais =========
    const inputMeasure = $('#measure-input');
    const btnSave     = $('#btn-save');
    const btnCancel   = $('#btn-cancel');
    const lastValueEl = $('#last-value');
    const badgeEl     = $('#result-badge');

    const fNominal = $('#f-nominal');
    const fTolP    = $('#f-tol-plus');
    const fTolM    = $('#f-tol-minus');
    const fUpper   = $('#f-upper');
    const fLower   = $('#f-lower');
    const fPiece   = $('#f-piece');
    const fCode    = $('#f-code');
    const fOperator= $('#f-operator');
    const fShift   = $('#f-shift');
    const fNotes   = $('#f-notes');

    // calcula limites ao digitar toler√¢ncias/nominal
    function toNum(v){ return Number(String(v).replace(',','.')); }
    function fmt(v){ return Number(v).toLocaleString('pt-BR',{minimumFractionDigits:4,maximumFractionDigits:4}); }

    function recalcLimits(){
      const nominal = toNum(fNominal.value);
      const plus    = toNum(fTolP.value);
      const minus   = toNum(fTolM.value);
      if (isFinite(nominal) && isFinite(plus) && isFinite(minus)){
        fUpper.value = fmt(nominal + plus);
        fLower.value = fmt(nominal + minus);
      }else{
        fUpper.value = '';
        fLower.value = '';
      }
    }
    ['input','change'].forEach(ev=>{
      fNominal.addEventListener(ev,recalcLimits);
      fTolP.addEventListener(ev,recalcLimits);
      fTolM.addEventListener(ev,recalcLimits);
    });

    // ========= valida√ß√µes m√≠nimas exigidas =========
    function requiredOk(){
      const miss = [];
      if(!fNominal.value.trim()) miss.push('Dimens√£o nominal');
      if(!fTolP.value.trim())    miss.push('Toler√¢ncia superior');
      if(!fTolM.value.trim())    miss.push('Toler√¢ncia inferior');
      if(!fPiece.value.trim())   miss.push('Pe√ßa');
      if(!fCode.value.trim())    miss.push('C√≥digo');
      if(miss.length){
        alert('Preencha: ' + miss.join(', ') + '.');
        return false;
      }
      return true;
    }

    // ========= comportamento do ENTER no campo de medi√ß√£o =========
    inputMeasure.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();     // N√ÉO submeter / N√ÉO mudar o foco
        btnSave.click();        // comportar-se como "Salvar"
      }
    });

    // ========= salvar / anular =========
    let globalCounter = Number(localStorage.getItem('globalCounter')||0);

    function saveToHistory(row){
      const all = JSON.parse(localStorage.getItem('history')||'[]');
      all.unshift(row);
      localStorage.setItem('history', JSON.stringify(all));
    }
    function renderHistory(){
      const tbody = document.querySelector('#history-table tbody');
      const all = JSON.parse(localStorage.getItem('history')||'[]');
      tbody.innerHTML = all.map(r=>`
        <tr>
          <td>${String(r.n).padStart(6,'0')}</td>
          <td>${r.date}</td>
          <td>${r.session}</td>
          <td>${r.piece}</td>
          <td>${r.code}</td>
          <td>${r.operator||''}</td>
          <td>${r.shift||''}</td>
          <td>${r.nominal}</td>
          <td>${r.tolP}</td>
          <td>${r.tolM}</td>
          <td>${r.value}</td>
          <td>${r.result}</td>
        </tr>
      `).join('');
    }

    function nowISO(){
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function currentSessionId(){
      // sess√£o simples baseada na data de hoje
      const d = new Date();
      return `SESS-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}${String(d.getSeconds()).padStart(2,'0')}`;
    }

    function setBadge(ok){
      if(ok===null){
        badgeEl.className='badge';
        badgeEl.textContent='Aguardando in√≠cio da medi√ß√£o';
      }else if(ok){
        badgeEl.className='badge ok';
        badgeEl.textContent='APROVADO';
      }else{
        badgeEl.className='badge nok';
        badgeEl.textContent='REPROVADO';
      }
    }

    function insideLimits(val, lo, hi){ return val>=lo && val<=hi; }

    btnSave.addEventListener('click', ()=>{
      if(!requiredOk()) return;

      const v = toNum(inputMeasure.value);
      if(!isFinite(v)){ inputMeasure.focus(); return; }

      const nominal = toNum(fNominal.value);
      const lo = toNum(fLower.value);
      const hi = toNum(fUpper.value);

      // alerta de muito fora (¬±1 al√©m do limite)
      if (v > hi + 1 || v < lo - 1){
        const proceed = confirm(`Valor ${v} est√° muito fora dos limites (${fmt(lo)} a ${fmt(hi)}).\nDeseja registrar assim mesmo?`);
        if(!proceed) return;
      }

      const ok = insideLimits(v, lo, hi);
      lastValueEl.textContent = fmt(v);
      setBadge(ok);

      globalCounter += 1;
      localStorage.setItem('globalCounter', String(globalCounter));

      const row = {
        n: globalCounter,
        date: nowISO(),
        session: currentSessionId(),
        piece: fPiece.value.trim(),
        code: fCode.value.trim(),
        operator: fOperator.value.trim(),
        shift: fShift.value.trim(),
        nominal: String(fNominal.value).trim(),
        tolP: String(fTolP.value).trim(),
        tolM: String(fTolM.value).trim(),
        value: fmt(v),
        result: ok ? 'OK' : 'NOK'
      };
      saveToHistory(row);

      inputMeasure.value='';
      inputMeasure.focus();
    });

    btnCancel.addEventListener('click', ()=>{
      // marca a √∫ltima medi√ß√£o como ANULADO (n√£o remove da tabela)
      const all = JSON.parse(localStorage.getItem('history')||'[]');
      if(all.length){
        all[0].result = 'ANULADO';
        localStorage.setItem('history', JSON.stringify(all));
        setBadge(null);
        lastValueEl.textContent = '‚Äì';
      }
    });

    // iniciar: apenas foca no campo de medi√ß√£o
    $('#btn-start').addEventListener('click', ()=>{
      inputMeasure.focus();
    });

    // limpar: limpa todos os campos e estado visual
    $('#btn-clear').addEventListener('click', ()=>{
      [fNominal,fTolP,fTolM,fUpper,fLower,fPiece,fCode,fOperator,fShift,fNotes,inputMeasure].forEach(el=>el.value='');
      setBadge(null);
      lastValueEl.textContent = '‚Äì';
    });

    // exporta√ß√£o CSV
    $('#btn-export').addEventListener('click', ()=>{
      const rows = JSON.parse(localStorage.getItem('history')||'[]');
      const header = ['N_Global','Data','Sessao_ID','Peca','Codigo','Operador','Turno','Nominal','Tol_P','Tol_M','Valor','Resultado'];
      const csv = [header.join(';')].concat(
        rows.map(r=>[r.n,r.date,r.session,r.piece,r.code,r.operator||'',r.shift||'',r.nominal,r.tolP,r.tolM,r.value,r.result].join(';'))
      ).join('\r\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'historico.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // limpar tudo (sem PIN real ‚Äì mant√©m como estava)
    $('#btn-clear-all').addEventListener('click', ()=>{
      if(confirm('Limpar todo o hist√≥rico local?')){
        localStorage.removeItem('history');
        localStorage.removeItem('globalCounter');
        renderHistory();
      }
    });

    // pin (placeholder)
    $('#btn-pin').addEventListener('click', ()=>{
      const pin = prompt('Digite um novo PIN (4-8 d√≠gitos):');
      if(pin && /^\d{4,8}$/.test(pin)){
        localStorage.setItem('pin',pin);
        alert('PIN atualizado.');
      }else if(pin!==null){
        alert('PIN inv√°lido.');
      }
    });
  </script>
</body>
</html>
