<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>INOVA – Measurement Lite Web v1.0.1</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0B6DB7">
  <link rel="icon" sizes="192x192" href="./icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="./icons/icon-512.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#0B6DB7; --brand-700:#0a5fa1;
      --ok:#2e7d32; --bad:#c62828;
      --bg:#f2f6fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --ring:rgba(11,109,183,.25); --radius:16px;
      --line:#1f6fb9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 600px at 50% -10%, #e8f1fb 0, transparent 60%),
        linear-gradient(#fff,#f6f9ff 25%, #eef3fb 100%);
    }
    .container{max-width:1080px; margin:24px auto; padding:0 16px}
    .screen{display:none} .screen.active{display:block}

    .card{background:var(--card); border-radius:var(--radius);
      box-shadow:0 6px 24px rgba(16,24,40,.06), inset 0 0 0 1px rgba(16,24,40,.05);
      padding:18px; position:relative}
    h1{font-size:clamp(22px,4vw,28px); margin:0 0 16px; font-weight:800; color:#0d2b4e}
    h2{font-size:clamp(18px,3.2vw,22px); margin:8px 0 12px; font-weight:700; color:#123b64}
    .muted{color:var(--muted)} .small{font-size:12px; color:#7c8aa0}
    .version-tag{position:absolute; right:12px; bottom:8px; font-size:12px; color:#7c8aa0}

    .btn{appearance:none; border:0; cursor:pointer; user-select:none; border-radius:12px;
      padding:12px 16px; font-weight:700; font-size:16px; display:inline-flex; align-items:center; justify-content:center; transition:.2s; min-width:0}
    .btn-primary{background:var(--brand); color:#fff}.btn-primary:hover{background:var(--brand-700)}
    .btn-ghost{background:#e7eef7; color:#334155}.btn-ghost:hover{background:#d9e6f5}
    .btn-danger{background:#f2c7c7; color:#7a1212}.btn-danger:hover{background:#efb9b9}
    .btn-warn{background:#f7cf8a; color:#5c3b00}
    .row{display:flex; gap:10px; flex-wrap:wrap}

    .input{width:100%; border:1px solid #e5e7eb; background:#fbfdff; border-radius:12px; padding:12px 14px; font-size:16px; outline:none; transition:.15s}
    .input:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--ring)}
    .input-readonly{background:#eef2f6; color:#475569; border-color:#e2e8f0;}

    .grid-form{display:grid; gap:12px; grid-template-columns:1fr}
    @media (min-width:980px){
      .grid-form{
        grid-template-columns:1fr 1fr;
        grid-template-areas:
          "nom nom"
          "plus minus"
          "piece piece"
          "code code"
          "op op"
          "shift shift";
      }
      .field-nom   { grid-area: nom; }
      .field-plus  { grid-area: plus; }
      .field-minus { grid-area: minus; }
      .field-piece { grid-area: piece; }
      .field-code  { grid-area: code; }
      .field-op    { grid-area: op; }
      .field-shift { grid-area: shift; }
    }

    .home-logo{display:block; margin:0 auto 12px; width:120px; opacity:.9}
    .home-title{text-align:center; font-size:clamp(26px,5vw,42px); font-weight:800; margin:12px 0}
    .home-sub{text-align:center; color:#8fa0b6; margin-bottom:20px}
    .home-actions{display:grid; gap:14px; max-width:420px; margin:0 auto}

    .measure-wrap{display:grid; gap:16px}
    @media (min-width:980px){.measure-wrap{grid-template-columns:1fr 1fr}}
    .panel-title{font-size:18px; font-weight:800; margin:0 0 10px}
    .kbd{font-size:12px; padding:2px 8px; background:#eef2f6; border-radius:999px}
    .measure-card{background:#f6f9fd; border-radius:14px; padding:16px; border:1px solid #e5edf8}
    .big-value{font-size:clamp(34px,8vw,96px); font-weight:900; letter-spacing:1px}
    .status{display:flex; align-items:center; gap:8px; font-weight:800; margin-top:8px}
    .dot{width:10px; height:10px; border-radius:999px; background:#94a3b8}
    .status.ok .dot{background:var(--ok)} .status.bad .dot{background:var(--bad)}
    .measure-actions{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:10px 0 6px}

    .chart{width:100%; height:240px; background:linear-gradient(#fff,#fff),
           repeating-linear-gradient(to right, transparent 0 60px, rgba(2,6,23,.06) 60px 61px),
           repeating-linear-gradient(to bottom, transparent 0 60px, rgba(2,6,23,.06) 60px 61px);
           border-radius:12px; border:1px solid #e5e7eb; position:relative; overflow:hidden}
    svg{display:block}

    .table{width:100%; border-collapse:separate; border-spacing:0; font-size:14px}
    .table th,.table td{padding:10px 12px; border-bottom:1px solid #eef2f7; white-space:nowrap}
    .table th{font-weight:800; color:#123b64; background:#f7fbff}
    .table-compact{font-size:13px}
    .table-compact th,.table-compact td{padding:8px 10px}

    .actions-row{display:flex; flex-wrap:wrap; gap:10px}
    @media (max-width:480px){.actions-row{flex-direction:column}}

    .modal-overlay{position:fixed; inset:0; background:rgba(2,6,23,.45); display:none; align-items:center; justify-content:center; z-index:50}
    .modal-overlay.show{display:flex}
    .modal{width:min(92vw,420px); background:#fff; border-radius:16px; padding:18px; box-shadow:0 24px 60px rgba(15,23,42,.25)}
    .modal h3{margin:0 0 8px; font-size:20px}
    .modal .field{display:flex; flex-direction:column; gap:6px; margin:8px 0}
    footer{margin:18px 0 6px; text-align:center; color:#8fa0b6; font-size:13px}
  </style>
</head>
<body>
  <main class="container">
    <!-- TELA 1 -->
    <section id="screen-home" class="screen active">
      <div class="card" style="text-align:center">
        <img class="home-logo" alt="INOVA Controle" src="./icons/icon-192.png">
        <h1 class="home-title">INOVA – Measurement Lite Web</h1>
        <div class="home-sub">Web</div>
        <div class="home-actions">
          <button class="btn btn-ghost" type="button" disabled>Cadastros (beta)</button>
          <button type="button" class="btn btn-primary" id="go-measure">Medição</button>
        </div>
        <span class="version-tag">v1.0.1</span>
        <footer>Desenvolvido por INOVA Controle®</footer>
      </div>
    </section>

    <!-- TELA 2 -->
    <section id="screen-measure" class="screen">
      <h1>Medição (Sessão atual)</h1>
      <div class="measure-wrap">

        <!-- Coluna esquerda -->
        <div>
          <div class="card measure-card" id="measure-card">
            <h2 class="panel-title">Medição realizada</h2>

            <form id="measure-form" autocomplete="off">
              <input id="value-input" class="input" placeholder="Digite o valor e pressione Enter"
                     inputmode="decimal" enterkeyhint="done" autocomplete="off">
              <div class="measure-actions">
                <button type="button" id="btn-save" class="btn btn-primary">Salvar</button>
                <button type="button" id="btn-cancel" class="btn btn-danger">Anular</button>
              </div>
            </form>

            <div class="big-value" id="big-value">–</div>
            <div class="status" id="status"><span class="dot"></span><span class="muted">Aguardando início da medição</span></div>
          </div>

          <div class="card" style="margin-top:12px">
            <h2 class="panel-title">Gráfico de medições</h2>
            <div class="chart">
              <svg id="lineSvg" viewBox="0 0 600 240" preserveAspectRatio="xMidYMid meet" width="100%" height="100%">
                <line id="limitMin" x1="10" x2="590" y1="200" y2="200" stroke="#0f172a" stroke-width="4" opacity=".35"/>
                <line id="limitMax" x1="10" x2="590" y1="40"  y2="40"  stroke="#0f172a" stroke-width="4" opacity=".35"/>
                <path id="linePath" d="M10,200 L590,200" stroke="var(--line)" stroke-width="3" fill="none"></path>
                <g id="points"></g>
              </svg>
            </div>
          </div>
        </div>

        <!-- Coluna direita -->
        <div class="card">
          <h2 class="panel-title">Configuração</h2>
          <div class="grid-form">
            <div class="field-nom">
              <label class="muted">Dimensão nominal <span class="kbd">*</span></label>
              <input id="f-nom" class="input" inputmode="decimal" autocomplete="off" required>
            </div>
            <div class="field-plus">
              <label class="muted">Tolerância superior <span class="kbd">*</span></label>
              <input id="f-tol-plus" class="input" inputmode="decimal" autocomplete="off" required>
            </div>
            <div class="field-minus">
              <label class="muted">Tolerância inferior <span class="kbd">*</span></label>
              <input id="f-tol-minus" class="input" inputmode="decimal" autocomplete="off" required>
            </div>
            <div>
              <label class="muted">Limite superior</label>
              <input id="f-max" class="input input-readonly" disabled>
            </div>
            <div>
              <label class="muted">Limite inferior</label>
              <input id="f-min" class="input input-readonly" disabled>
            </div>
            <div class="field-piece">
              <label class="muted">Nome da peça <span class="kbd">*</span></label>
              <input id="f-piece" class="input" list="list-piece" autocomplete="off" required>
              <datalist id="list-piece"></datalist>
            </div>
            <div class="field-code">
              <label class="muted">Código <span class="kbd">*</span></label>
              <input id="f-code" class="input" list="list-code" autocomplete="off" required>
              <datalist id="list-code"></datalist>
            </div>
            <div class="field-op">
              <label class="muted">Operador (opcional)</label>
              <input id="f-operator" class="input" list="list-operator" autocomplete="off">
              <datalist id="list-operator"></datalist>
            </div>
            <div class="field-shift">
              <label class="muted">Turno (opcional)</label>
              <input id="f-shift" class="input" list="list-shift" placeholder="Ex.: 1, 2, 3" autocomplete="off">
              <datalist id="list-shift"></datalist>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button type="button" class="btn btn-primary" id="btn-start">Iniciar</button>
            <button type="button" class="btn btn-ghost"   id="btn-clear">Limpar</button>
            <button type="button" class="btn btn-ghost"   id="btn-history">Ver valores</button>
          </div>

          <div style="margin-top:10px">
            <label class="muted">Observações (opcional)</label>
            <textarea id="f-notes" class="input" rows="4" style="resize:vertical"></textarea>
          </div>

          <div class="card" style="margin-top:12px; padding:12px">
            <h2 class="panel-title" style="margin-bottom:6px">Resultados recentes</h2>
            <div style="overflow:auto">
              <table class="table table-compact" id="mini-table">
                <thead>
                  <tr><th>Nº</th><th>Hora</th><th>Valor</th><th>Resultado</th></tr>
                </thead>
                <tbody id="mini-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TELA 3 -->
    <section id="screen-history" class="screen">
      <h1>Histórico Global & Exportação</h1>
      <div class="card">
        <h2 class="panel-title">Ações</h2>
        <div class="actions-row" style="margin-bottom:12px">
          <button type="button" class="btn btn-warn"   id="btn-pin">Definir/Alterar PIN</button>
          <button type="button" class="btn btn-primary" id="btn-export">Exportar CSV</button>
          <button type="button" class="btn btn-danger"  id="btn-clear-history">Limpar histórico local</button>
        </div>

        <div class="card" style="padding:0">
          <div style="overflow:auto">
            <table class="table" id="history-table">
              <thead>
              <tr>
                <th>Nº Global</th><th>Data</th><th>Sessão_ID</th><th>Peça</th><th>Código</th>
                <th>Operador</th><th>Turno</th><th>Nominal</th><th>Tol. +</th><th>Tol. -</th><th>Valor</th><th>Observações</th><th>Resultado</th>
              </tr>
              </thead>
              <tbody id="history-body"></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:12px">
          <button type="button" class="btn btn-ghost" id="back-to-measure">Voltar à Medição</button>
          <button type="button" class="btn btn-ghost" id="back-home">Voltar ao Início</button>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL PIN -->
  <div id="modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal">
      <h3 id="modal-title">PIN</h3>
      <div id="modal-content" class="content"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px">
        <button type="button" id="pin-cancel" class="btn btn-ghost">Cancelar</button>
        <button type="button" id="pin-ok" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', () => {

    /* ===== Navegação ===== */
    const screens = {
      home:    document.getElementById('screen-home'),
      measure: document.getElementById('screen-measure'),
      history: document.getElementById('screen-history'),
    };
    const show = (el) => { Object.values(screens).forEach(s => s.classList.remove('active')); el.classList.add('active'); };
    document.getElementById('go-measure').addEventListener('click', () => show(screens.measure));
    document.getElementById('back-to-measure').addEventListener('click', () => show(screens.measure));
    document.getElementById('back-home').addEventListener('click', () => show(screens.home));

    /* ===== Estado ===== */
    const el = {
      nom: q('#f-nom'), plus: q('#f-tol-plus'), minus: q('#f-tol-minus'),
      max: q('#f-max'), min: q('#f-min'),
      piece: q('#f-piece'), code: q('#f-code'), op: q('#f-operator'), shift: q('#f-shift'),
      notes: q('#f-notes'),
      input: q('#value-input'), save: q('#btn-save'), cancel: q('#btn-cancel'),
      big: q('#big-value'), status: q('#status'), start: q('#btn-start'), clear: q('#btn-clear'),
      miniBody: q('#mini-body'),
      historyBody: q('#history-body'), export: q('#btn-export'), clearHistory: q('#btn-clear-history'),
      btnHistory: q('#btn-history'),
      limitMin: q('#limitMin'), limitMax: q('#limitMax'), linePath: q('#linePath'), points: q('#points'),
      svg: q('#lineSvg'),
      modal: q('#modal'), modalTitle: q('#modal-title'), modalContent: q('#modal-content'),
      pinCancel: q('#pin-cancel'), pinOk: q('#pin-ok'), pinBtn: q('#btn-pin'),
      form: q('#measure-form'),
      listPiece: q('#list-piece'), listCode: q('#list-code'),
      listOp: q('#list-operator'), listShift: q('#list-shift'),
    };

    const LS_PIN='inova_pin';
    const LS_LISTS={
      piece:'inova_list_piece',
      code:'inova_list_code',
      op:'inova_list_operator',
      shift:'inova_list_shift',
      MAX:10
    };
    const LS_HISTORY='inova_history';

    let session = resetSession();

    function resetSession(){
      return {
        values: [], results: [],
        nominal: null, tolPlus: null, tolMinus:null,
        limMax: null, limMin: null,
        piece:'', code:'', operator:'', shift:'',
        sessionId: null, started:false
      };
    }

    function q(s){ return document.querySelector(s); }
    function nowStr(){
      const d=new Date();
      const p=n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
    }
    function makeSessionId(){
      const d=new Date(); const p=n=>String(n).padStart(2,'0');
      return `SESS-${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`;
    }
    function toNum(v){ return parseFloat(String(v).replace(',','.')); }

    /* ===== Datalists ===== */
    function loadList(key){
      try{ return JSON.parse(localStorage.getItem(key) || '[]'); }catch{return [];}
    }
    function saveList(key, arr){
      localStorage.setItem(key, JSON.stringify(arr.slice(0, LS_LISTS.MAX)));
    }
    function addToList(key, value){
      const v=(value||'').trim(); if(!v) return;
      const list = loadList(key).filter(x=>x && String(x).trim()!=='');
      const exists = list.findIndex(x=>String(x).toLowerCase()===v.toLowerCase());
      if(exists>-1) list.splice(exists,1);
      list.unshift(v);
      saveList(key, list);
    }
    function renderDatalist(datalistEl, arr){
      datalistEl.innerHTML='';
      arr.forEach(item=>{
        const opt=document.createElement('option');
        opt.value=item;
        datalistEl.appendChild(opt);
      });
    }
    function refreshAllDatalists(){
      renderDatalist(el.listPiece, loadList(LS_LISTS.piece));
      renderDatalist(el.listCode,  loadList(LS_LISTS.code));
      renderDatalist(el.listOp,    loadList(LS_LISTS.op));
      renderDatalist(el.listShift, loadList(LS_LISTS.shift));
    }

    /* ===== Histórico (persistência) ===== */
    function loadHistory(){
      try{ return JSON.parse(localStorage.getItem(LS_HISTORY) || '[]'); }catch{return [];}
    }
    function saveHistory(arr){
      localStorage.setItem(LS_HISTORY, JSON.stringify(arr));
    }
    function getNextCounterFrom(historyArr){
      const maxNum = historyArr.reduce((m, r)=>{
        const n = parseInt(r.num,10);
        return Number.isFinite(n) && n>m ? n : m;
      }, 0);
      return maxNum + 1;
    }
    function renderHistoryTable(historyArr){
      el.historyBody.innerHTML='';
      for(let i=historyArr.length-1;i>=0;i--){
        const r = historyArr[i];
        const tr=document.createElement('tr');
        const fullRow=[r.num, r.date, r.sessionId, r.piece, r.code, r.operator, r.shift,
                       r.nominal, r.tolPlus, r.tolMinus, r.value, (r.notes??''), r.result];
        tr.innerHTML = fullRow.map(c=>`<td>${c}</td>`).join('');
        el.historyBody.appendChild(tr);
      }
    }

    let historyStore = loadHistory();
    let counter = getNextCounterFrom(historyStore);
    renderHistoryTable(historyStore);

    /* ===== Limites ===== */
    function computeLimits(){
      const nominal = toNum(el.nom.value);
      const plus    = toNum(el.plus.value);
      const minus   = toNum(el.minus.value);
      if([nominal,plus,minus].some(x=>Number.isNaN(x))) return;
      const limMax = +(nominal + plus).toFixed(4);
      const limMin = +(nominal + minus).toFixed(4);
      el.max.value = limMax.toFixed(4);
      el.min.value = limMin.toFixed(4);
      session.nominal = nominal; session.tolPlus = plus; session.tolMinus = minus;
      session.limMax = limMax; session.limMin = limMin;
      redrawChart();
    }
    [el.nom,el.plus,el.minus].forEach(i=>i.addEventListener('input',computeLimits));

    function configValid(){
      const required = [el.nom, el.plus, el.minus, el.piece, el.code];
      let ok=true;
      required.forEach(i=>{
        const empty = !i.value || i.value.toString().trim()==='';
        i.style.borderColor = empty ? '#ef4444' : '#e5e7eb';
        ok = ok && !empty;
      });
      if(!ok) alert('Preencha os campos obrigatórios: Dimensão nominal, Tol. superior, Tol. inferior, Peça e Código.');
      return ok;
    }

    el.start.addEventListener('click', ()=>{
      if(!configValid()) return;
      computeLimits();
      session.piece=el.piece.value.trim(); session.code=el.code.value.trim();
      session.operator=el.op.value.trim(); session.shift=el.shift.value.trim();
      session.sessionId = makeSessionId();
      session.started = true;

      addToList(LS_LISTS.piece, session.piece);
      addToList(LS_LISTS.code,  session.code);
      if(session.operator) addToList(LS_LISTS.op, session.operator);
      if(session.shift)    addToList(LS_LISTS.shift, session.shift);
      refreshAllDatalists();

      document.getElementById('measure-card').scrollIntoView({behavior:'smooth', block:'start'});
      setTimeout(()=>{ el.input.focus(); }, 100);

      el.status.className='status'; el.status.innerHTML='<span class="dot"></span><span class="muted">Sessão iniciada</span>';
    });

    el.clear.addEventListener('click', ()=>{
      [el.nom,el.plus,el.minus,el.piece,el.code,el.op,el.shift,el.notes,el.input, el.max, el.min].forEach(i=>i.value='');
      session = resetSession();
      clearChart();
      updateMini();
      el.big.textContent='–';
      el.status.className='status'; el.status.innerHTML='<span class="dot"></span><span class="muted">Aguardando início da medição</span>';
      el.input.focus();
    });

    /* ===== Salvar medições ===== */
    function saveValue(fromStr){
      if(!session.started || !configValid()){ alert('Inicie a sessão e preencha os campos obrigatórios.'); return; }
      const txt = (fromStr ?? el.input.value).toString().trim().replace(',','.');
      if(!txt) return;
      const value = parseFloat(txt);
      if(Number.isNaN(value)) return;

      if((value > session.limMax + 1) || (value < session.limMin - 1)){
        const ok = confirm(`Valor ${value.toLocaleString('pt-BR')} está muito fora dos limites (${session.limMin} a ${session.limMax}).\nDeseja registrar assim mesmo?`);
        if(!ok) return;
      }

      const result = (value >= session.limMin && value <= session.limMax) ? 'OK' : 'NOK';
      session.values.push(value);
      session.results.push(result);
      el.big.textContent = value.toLocaleString('pt-BR',{minimumFractionDigits:4});
      el.status.className = 'status ' + (result==='OK'?'ok':'bad');
      el.status.innerHTML = `<span class="dot"></span> <span>${result==='OK'?'APROVADO':'REPROVADO'}</span>`;

      pushHistoryRow(value, result);
      el.input.value='';
      redrawChart();
      updateMini();
      el.input.focus();
    }

    el.save.addEventListener('click', ()=>saveValue());

    /* Enter robusto */
    function handleEnter(e){
      const isEnter = e.key === 'Enter' || e.key === 'Return' || e.code === 'Enter' || e.keyCode === 13;
      if(isEnter){
        e.preventDefault(); e.stopPropagation();
        saveValue();
        setTimeout(()=> el.input.focus(), 0);
        return false;
      }
    }
    ['keydown','keypress','keyup'].forEach(evt=>{
      el.input.addEventListener(evt, handleEnter, true);
    });
    el.form.addEventListener('submit', (e)=>{
      e.preventDefault(); e.stopPropagation();
      saveValue();
      setTimeout(()=> el.input.focus(), 0);
      return false;
    });
    el.input.addEventListener('input', (e)=>{
      const v = e.target.value;
      if(v && /\n/.test(v)){
        e.target.value = v.replace(/\n/g,'');
        saveValue();
        setTimeout(()=> el.input.focus(), 0);
      }
    });

    /* ===== Histórico + horário BR ===== */
    const fmtBR = new Intl.DateTimeFormat('pt-BR', {
      timeZone: 'America/Sao_Paulo',
      dateStyle: 'short',
      timeStyle: 'medium'
    });

    function pushHistoryRow(v, result){
      const when=new Date();
      const num=String(counter).padStart(6,'0');
      const sess=session.sessionId ?? makeSessionId();

      const rowObj = {
        num,
        date: fmtBR.format(when),
        sessionId: sess,
        piece: el.piece.value||'-',
        code:  el.code.value||'-',
        operator: el.op.value||'-',
        shift: el.shift.value||'-',
        nominal: (session.nominal??0).toFixed(4),
        tolPlus: (session.tolPlus??0).toFixed(4),
        tolMinus:(session.tolMinus??0).toFixed(4),
        value: (+v).toFixed(4),
        notes: (el.notes.value||'').trim(),   // <<=== Observações no histórico
        result
      };

      historyStore.push(rowObj);
      saveHistory(historyStore);

      const tr=document.createElement('tr');
      const fullRow=[rowObj.num,rowObj.date,rowObj.sessionId,rowObj.piece,rowObj.code,
                     rowObj.operator,rowObj.shift,rowObj.nominal,rowObj.tolPlus,rowObj.tolMinus,rowObj.value,rowObj.notes,rowObj.result];
      tr.innerHTML=fullRow.map(c=>`<td>${c}</td>`).join('');
      el.historyBody.prepend(tr);

      counter++;
    }

    /* Exportar CSV (UTF-8 + BOM) com cabeçalhos ASCII e Observacoes */
    el.export.addEventListener('click',()=>{
      const header = ['Num_Global','Data','Sessao_ID','Peca','Codigo','Operador','Turno','Nominal','Tol_mais','Tol_menos','Valor','Observacoes','Resultado'];
      const rows = [header];

      historyStore.forEach(r=>{
        const line = [
          r.num ?? '',
          r.date ?? '',
          r.sessionId ?? '',
          r.piece ?? '',
          r.code ?? '',
          r.operator ?? '',
          r.shift ?? '',
          r.nominal ?? '',
          r.tolPlus ?? '',
          r.tolMinus ?? '',
          r.value ?? '',
          (r.notes ?? ''),
          r.result ?? ''
        ];
        rows.push(line);
      });

      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(';')).join('\r\n');
      const csvWithBom = "\uFEFF" + csv; // força UTF-8 no Excel/Sheets

      const blob=new Blob([csvWithBom],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='inova_measurements.csv';
      a.click(); URL.revokeObjectURL(a.href);
    });

    el.clearHistory.addEventListener('click',()=>{
      if(confirm('Limpar histórico local?')){
        el.historyBody.innerHTML='';
        historyStore = [];
        saveHistory(historyStore);
        counter = 1;
      }
    });

    /* ===== PIN ===== */
    function getStoredPin(){
      const raw = localStorage.getItem(LS_PIN);
      return (raw===null || raw==='null' || raw==='undefined' || raw==='') ? null : raw;
    }
    function openModal(title, contentHTML, onOk){
      el.modalTitle.textContent=title;
      el.modalContent.innerHTML=contentHTML;
      el.modal.classList.add('show');
      el.pinCancel.onclick = ()=> el.modal.classList.remove('show');
      el.pinOk.onclick = ()=> onOk?.();
    }
    function requestPinIfNeeded(onOk){
      const pin = getStoredPin();
      if(!pin){ onOk?.(); return; }
      openModal(
        'PIN necessário',
        `<div class="field"><label class="muted">Digite o PIN para confirmar</label><input id="pin-in" class="input" inputmode="numeric" type="password" autocomplete="one-time-code"></div>`,
        ()=>{
          const v=q('#pin-in').value||'';
          if(v===pin){ el.modal.classList.remove('show'); onOk?.(); }
          else alert('PIN incorreto.');
        }
      );
    }

    /* ===== Anular com PIN ===== */
    function performAnnul(){
      if(!session.values.length){
        el.input.focus();
        return;
      }
      const value = session.values.pop();
      session.results.pop();
      redrawChart();
      updateMini();
      el.status.className='status';
      el.status.innerHTML='<span class="dot"></span><span class="muted">Última medição anulada</span>';
      pushHistoryRow(value,'ANULADO');
      setTimeout(()=> el.input.focus(), 0);
    }
    el.cancel.addEventListener('click', ()=>{
      requestPinIfNeeded(performAnnul);
    });

    /* ===== Mini-tabela ===== */
    function updateMini(){
      el.miniBody.innerHTML='';
      session.values.forEach((v,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${idx+1}</td><td>${nowStr().split(' ')[1]}</td><td>${(+v).toFixed(4)}</td><td>${session.results[idx]}</td>`;
        el.miniBody.appendChild(tr);
      });
    }

    /* ===== Gráfico ===== */
    function clearChart(){
      el.linePath.setAttribute('d','M10,200 L590,200');
      el.points.innerHTML='';
      el.limitMin.setAttribute('y1',200); el.limitMin.setAttribute('y2',200);
      el.limitMax.setAttribute('y1',40);  el.limitMax.setAttribute('y2',40);
    }
    function redrawChart(){
      const W=600, H=240, L=10, R=590;
      if(session.limMin==null || session.limMax==null){ clearChart(); return; }

      const pts=session.values.slice();
      const minV = Math.min(session.limMin, ...pts);
      const maxV = Math.max(session.limMax, ...pts);
      const span = (maxV - minV) || 1;
      const yMap = v => {
        const t=(v - minV)/span;
        const y = H - 20 - t*(H-40);
        return Math.max(20, Math.min(H-20, y));
      };
      const step = pts.length>1 ? (R-L)/(pts.length-1) : 0;

      el.limitMin.setAttribute('y1', yMap(session.limMin));
      el.limitMin.setAttribute('y2', yMap(session.limMin));
      el.limitMax.setAttribute('y1', yMap(session.limMax));
      el.limitMax.setAttribute('y2', yMap(session.limMax));

      let d='';
      pts.forEach((v,i)=>{
        const x = L + i*step, y = yMap(v);
        d += (i? ' L':'M')+x+','+y;
      });
      el.linePath.setAttribute('d', d || 'M10,200 L590,200');

      el.points.innerHTML='';
      pts.forEach((v,i)=>{
        const x = L + i*step, y = yMap(v);
        const isOk = (v>=session.limMin && v<=session.limMax);

        if(isOk){
          const s=12;
          const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
          rect.setAttribute('x', x - s/2); rect.setAttribute('y', y - s/2);
          rect.setAttribute('width', s); rect.setAttribute('height', s);
          rect.setAttribute('fill', '#2e7d32');
          el.points.appendChild(rect);
        }else{
          const s=14;
          const poly=document.createElementNS('http://www.w3.org/2000/svg','polygon');
          const p1 = `${x},${y - s/2}`;
          const p2 = `${x - s/2},${y + s/2}`;
          const p3 = `${x + s/2},${y + s/2}`;
          poly.setAttribute('points', `${p1} ${p2} ${p3}`);
          poly.setAttribute('fill', '#c62828');
          el.points.appendChild(poly);
        }
      });
    }

    /* ===== Tela 3 com PIN ===== */
    el.btnHistory.addEventListener('click', ()=>{
      const pin = getStoredPin();
      const go = ()=> show(screens.history);
      if(!pin){ go(); return; }
      try{
        openModal(
          'Digite o PIN',
          `<div class="field"><label class="muted">PIN</label><input id="pin-in" class="input" inputmode="numeric" type="password" autocomplete="one-time-code"></div>`,
          ()=>{
            const v=q('#pin-in').value||'';
            if(v===pin){ el.modal.classList.remove('show'); go(); }
            else alert('PIN incorreto.');
          }
        );
      }catch(e){
        console.error('Falha ao abrir modal PIN, navegando mesmo assim:', e);
        go();
      }
    });

    el.pinBtn.addEventListener('click', ()=>{
      const cur = localStorage.getItem(LS_PIN)||'';
      openModal('Definir/Alterar PIN',
        `${cur?'<div class="field"><label class="muted">PIN atual</label><input id="pin-old" class="input" inputmode="numeric" type="password"></div>':''}
         <div class="field"><label class="muted">Novo PIN</label><input id="pin-new" class="input" inputmode="numeric" type="password"></div>`,
        ()=>{
          const old=q('#pin-old')?.value??''; const nw=q('#pin-new')?.value??'';
          if(!nw){ alert('Informe o novo PIN.'); return; }
          if(cur && cur!==old){ alert('PIN atual incorreto.'); return; }
          localStorage.setItem(LS_PIN,nw);
          el.modal.classList.remove('show');
          alert('PIN atualizado!');
        });
    });

    /* Inicializações */
    refreshAllDatalists();
    show(screens.home);
  });
  </script>
</body>
</html>
