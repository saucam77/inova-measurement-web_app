<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>INOVA ‚Äì Measurement (Web)</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0B6DB7">

<style>
  :root{
    --brand:#0B6DB7;
    --ok:#16a34a;
    --nok:#dc2626;
    --panel:#f5f7fb;
    --muted:#6b7280;
    --ring: rgba(11,109,183,.25);
    --gap:12px;
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:#0f172a;background:#eef2f7;
  }
  .container{max-width:980px;margin:0 auto;padding:16px}
  .card{
    background:white;border-radius:var(--radius);
    box-shadow:0 8px 20px rgba(15,23,42,.06),0 1px 2px rgba(15,23,42,.08);
    border:1px solid #e5e7eb;
  }
  .section{padding:20px}
  h1{font-size:clamp(22px,3.2vw,28px);margin:0 0 16px}
  h2{font-size:clamp(18px,2.8vw,22px);margin:0 0 12px}
  .muted{color:var(--muted)}
  .hero{display:grid;place-items:center;text-align:center;padding:40px 20px}
  .logo{
    width:80px;height:80px;border-radius:18px;
    display:grid;place-items:center;color:white;background:#0f172a;margin-bottom:10px
  }
  .btn{
    appearance:none;border:0;cursor:pointer;
    background:var(--brand);color:#fff;font-weight:700;
    padding:12px 16px;border-radius:10px;
    box-shadow:0 1px 0 rgba(0,0,0,.05), inset 0 -1px 0 rgba(255,255,255,.15);
  }
  .btn:focus{outline:3px solid var(--ring)}
  .btn.muted{background:#94a3b8}
  .btn.red{background:var(--nok)}
  .btn.ghost{
    background:#e6eef6;color:#0b4a80;font-weight:600;
  }
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
  .stack{display:grid;gap:var(--gap)}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap}
  input,textarea{
    width:100%;padding:12px 14px;border-radius:10px;border:1px solid #dbe3ee;background:#fff;
    font:inherit;
  }
  input:focus,textarea:focus{outline:3px solid var(--ring)}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#eef2f7;color:#0b4a80;font-weight:700}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .dot.ok{background:var(--ok)} .dot.nok{background:var(--nok)}
  .measure-panel{display:grid;gap:14px}
  .big-reading{font-size:42px;font-weight:800;letter-spacing:.5px}
  .footer-note{color:#64748b;font-size:12px}
  .version{position:fixed;right:10px;bottom:10px;color:#64748b;font-size:12px}
  /* A√ß√µes (Iniciar/Limpar/Ver valores + Conectar BT) */
  .actions-grid{
    display:grid;gap:var(--gap);
    grid-template-columns:repeat(3,1fr);
  }
  /* Conectar BT ocupa a soma de 2 bot√µes */
  #btn-bt{grid-column:span 2}
  /* Responsivo */
  @media (max-width:640px){
    .grid-2{grid-template-columns:1fr}
  }

  /* Tabela compacta tela 2 */
  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{background:#f3f6fb;color:#0b4a80;text-align:left;padding:10px}
  tbody td{padding:10px;border-top:1px solid #e5e7eb}
  .tag{padding:2px 8px;border-radius:999px;font-weight:700}
  .tag.ok{background:#e7f7ec;color:#065f46}
  .tag.nok{background:#fde8e8;color:#991b1b}
  .tag.void{background:#f3f4f6;color:#374151}
  .link{color:#0b4a80;text-decoration:none}
</style>
</head>
<body>

<main id="app" class="container">
  <!-- ========== TELA 1 (HOME) ========== -->
  <section id="screen-home" class="card hero">
    <div class="logo">üóíÔ∏è</div>
    <h1>INOVA- Measurement</h1>
    <p class="muted">Web</p>
    <button class="btn" onclick="goTo('screen-measure')">Medi√ß√£o</button>
    <p class="footer-note" style="margin-top:20px">Desenvolvido por INOVA Controle¬Æ</p>
  </section>

  <!-- ========== TELA 2 (MEDI√á√ÉO) ========== -->
  <section id="screen-measure" class="stack" style="display:none;margin-top:12px">
    <h1>Medi√ß√£o (Sess√£o atual)</h1>

    <!-- Painel de medi√ß√£o -->
    <div class="card section measure-panel" id="panel-measure">
      <h2>Medi√ß√£o realizada</h2>
      <input id="input-reading" type="text" inputmode="decimal" placeholder="Digite o valor e pressione Enter"/>
      <div class="row">
        <button class="btn" id="btn-save">Salvar</button>
        <button class="btn red" id="btn-cancel">Anular</button>
      </div>

      <div class="big-reading" id="last-reading">‚Äî</div>
      <div class="pill" id="status-pill"><span class="dot" id="status-dot"></span><span id="status-text">Aguardando in√≠cio da medi√ß√£o</span></div>
    </div>

    <!-- Gr√°fico -->
    <div class="card section">
      <h2>Gr√°fico de medi√ß√µes</h2>
      <div id="chart-wrap" style="width:100%;height:260px">
        <svg id="chart" viewBox="0 0 1000 300" preserveAspectRatio="xMidYMid meet"></svg>
      </div>
    </div>

    <!-- Configura√ß√£o -->
    <div class="card section">
      <h2>Configura√ß√£o</h2>
      <div class="grid-2">
        <div class="stack">
          <label>Dimens√£o nominal <span class="muted">*</span></label>
          <input id="nominal" type="text" placeholder="Ex.: 28"/>
        </div>
        <div class="stack">
          <label>Toler√¢ncia superior <span class="muted">*</span></label>
          <input id="tolPlus" type="text" placeholder="Ex.: +0,200"/>
        </div>
        <div class="stack">
          <label>Toler√¢ncia inferior <span class="muted">*</span></label>
          <input id="tolMinus" type="text" placeholder="Ex.: -0,200"/>
        </div>
        <div class="stack">
          <label>Limite superior</label>
          <input id="limitHigh" type="text" disabled/>
        </div>
        <div class="stack">
          <label>Limite inferior</label>
          <input id="limitLow" type="text" disabled/>
        </div>
        <div class="stack">
          <label>Nome da pe√ßa <span class="muted">*</span></label>
          <input id="partName" type="text" placeholder="Ex.: BUCHA"/>
        </div>
        <div class="stack">
          <label>C√≥digo <span class="muted">*</span></label>
          <input id="partCode" type="text" placeholder="Ex.: 1452-25"/>
        </div>
        <div class="stack">
          <label>Operador (opcional)</label>
          <input id="operator" type="text" placeholder="Ex.: Saulo"/>
        </div>
        <div class="stack">
          <label>Turno (opcional)</label>
          <input id="shift" type="text" placeholder="Ex.: 1, 2, 3"/>
        </div>
      </div>

      <div class="stack" style="margin-top:14px">
        <div class="actions-grid">
          <button class="btn" id="btn-start">Iniciar</button>
          <button class="btn muted" id="btn-clear">Limpar</button>
          <button class="btn ghost" id="btn-history">Ver valores</button>
          <!-- Conectar BT ocupa a soma das 2 primeiras colunas -->
          <button class="btn ghost" id="btn-bt" title="Conex√£o Bluetooth">Conectar BT</button>
        </div>
        <div class="stack">
          <label>Observa√ß√µes (opcional)</label>
          <textarea id="notes" rows="3" placeholder="Anote aqui informa√ß√µes relevantes desta sess√£o"></textarea>
        </div>
      </div>
    </div>

    <!-- Tabela compacta (sempre vis√≠vel) -->
    <div class="card section">
      <h2>Valores desta sess√£o</h2>
      <div id="session-table"></div>
    </div>

    <p class="footer-note" style="text-align:center">Desenvolvido por INOVA Controle¬Æ</p>
  </section>

  <!-- ========== TELA 3 (HIST√ìRICO) ========== -->
  <section id="screen-history" class="stack" style="display:none;margin-top:12px">
    <h1>Hist√≥rico Global & Exporta√ß√£o</h1>
    <div class="card section stack">
      <div class="row">
        <button class="btn muted" id="btn-pin">Definir/Alterar PIN</button>
        <button class="btn ghost" id="btn-export">Exportar CSV</button>
        <button class="btn red" id="btn-clear-all">Limpar hist√≥rico local</button>
      </div>
      <div id="global-table" style="margin-top:10px"></div>
      <div class="row">
        <button class="btn muted" onclick="goTo('screen-measure')">Voltar √† Medi√ß√£o</button>
      </div>
    </div>
    <p class="footer-note" style="text-align:center">Desenvolvido por INOVA Controle¬Æ</p>
  </section>
</main>

<!-- Vers√£o -->
<div class="version">v1.0.0</div>

<script>
/* ======= util ======= */
const $ = sel => document.querySelector(sel);
const fmt = n => (Number(n).toLocaleString('pt-BR',{minimumFractionDigits:4, maximumFractionDigits:4}));
const toNum = (s)=> Number(String(s).replace('.','').replace(',','.'));
const ok = (v, lo, hi)=> v>=lo && v<=hi;

/* ======= navega√ß√£o ======= */
function goTo(id){
  ['screen-home','screen-measure','screen-history'].forEach(s=>{
    document.getElementById(s).style.display = (s===id)?'block':'none';
  });
  if(id==='screen-measure'){
    // foca input ao entrar
    setTimeout(()=> {
      $('#panel-measure').scrollIntoView({behavior:'smooth',block:'start'});
      $('#input-reading').focus();
    }, 120);
  }
}

/* ======= estado ======= */
let session = {
  nominal:null, plus:null, minus:null, hi:null, lo:null,
  partName:'', partCode:'', operator:'', shift:'', notes:'',
  values:[]  // {v, ts, ok, tag?}
};
let globalData = []; // mock, mantemos API local

/* ======= UI: limites autom√°ticos ======= */
function recalcLimits(){
  const nominal = toNum($('#nominal').value);
  const plus    = toNum($('#tolPlus').value);
  const minus   = toNum($('#tolMinus').value);
  if(!isNaN(nominal) && !isNaN(plus) && !isNaN(minus)){
    const hi = nominal + plus;
    const lo = nominal + minus;
    $('#limitHigh').value = fmt(hi);
    $('#limitLow').value  = fmt(lo);
    session.nominal = nominal; session.plus=plus; session.minus=minus; session.hi=hi; session.lo=lo;
    drawChart();
  }
}
['#nominal','#tolPlus','#tolMinus'].forEach(sel=>{
  $(sel).addEventListener('input', recalcLimits);
});

/* ======= UI: status ======= */
function setStatus(state, txt){
  const dot = $('#status-dot'); const pill = $('#status-pill'); const t = $('#status-text');
  t.textContent = txt;
  if(state==='ok'){ dot.className='dot ok'; }
  else if(state==='nok'){ dot.className='dot nok'; }
  else { dot.className='dot'; }
}

/* ======= gr√°fico SVG ======= */
function drawChart(){
  const svg = $('#chart');
  const w=1000, h=300, pad=30;
  svg.innerHTML='';
  // eixo / linhas de limite
  const vals = session.values.map(x=>x.v);
  const haveLimits = (typeof session.hi==='number' && typeof session.lo==='number' && !isNaN(session.hi)&&!isNaN(session.lo));
  const minV = Math.min(...vals, haveLimits?session.lo:Infinity);
  const maxV = Math.max(...vals, haveLimits?session.hi:-Infinity);
  if(!isFinite(minV) || !isFinite(maxV)){ return; }

  const range = Math.max( (maxV-minV) || 1, 0.0001);
  const x = i => pad + (i*(w-2*pad))/Math.max(vals.length-1,1);
  const y = v => h - pad - ((v-minV)*(h-2*pad)/range);

  // grades/limites
  if(haveLimits){
    const yHi = y(session.hi), yLo = y(session.lo);
    svg.insertAdjacentHTML('beforeend', `<line x1="${pad}" y1="${yHi}" x2="${w-pad}" y2="${yHi}" stroke="#9ca3af" stroke-width="4" opacity=".65"/>`);
    svg.insertAdjacentHTML('beforeend', `<line x1="${pad}" y1="${yLo}" x2="${w-pad}" y2="${yLo}" stroke="#9ca3af" stroke-width="4" opacity=".65"/>`);
  }

  // linha
  let d='';
  session.values.forEach((pt,i)=>{
    d += (i? ' L':'M')+x(i)+','+y(pt.v);
  });
  if(session.values.length){
    svg.insertAdjacentHTML('beforeend', `<path d="${d}" fill="none" stroke="#1e3a8a" stroke-width="3"/>`);
  }

  // marcadores (quadrado OK, tri√¢ngulo NOK)
  session.values.forEach((pt,i)=>{
    const cx = x(i), cy = y(pt.v);
    if(pt.ok){
      const s=10; // quadrado
      svg.insertAdjacentHTML('beforeend', `<rect x="${cx - s/2}" y="${cy - s/2}" width="${s}" height="${s}" fill="#16a34a" />`);
    }else{
      const s=12; // tri√¢ngulo
      const p1=`${cx},${cy - s/2}`;
      const p2=`${cx - s/2},${cy + s/2}`;
      const p3=`${cx + s/2},${cy + s/2}`;
      svg.insertAdjacentHTML('beforeend', `<polygon points="${p1} ${p2} ${p3}" fill="#dc2626"/>`);
    }
  });
}

/* ======= tabela sess√£o ======= */
function renderSessionTable(){
  const rows = session.values.map((r,i)=>`
    <tr>
      <td>${String(i+1).padStart(6,'0')}</td>
      <td>${new Date(r.ts).toLocaleString('pt-BR')}</td>
      <td>${fmt(r.v)}</td>
      <td>${r.ok?'<span class="tag ok">OK</span>':'<span class="tag nok">NOK</span>'}</td>
    </tr>
  `).join('');
  $('#session-table').innerHTML = `
    <div class="card section" style="padding:0">
      <table>
        <thead>
          <tr>
            <th style="width:100px">N¬∫</th>
            <th>Data</th>
            <th style="width:140px">Valor</th>
            <th style="width:110px">Resultado</th>
          </tr>
        </thead>
        <tbody>${rows || '<tr><td colspan="4" class="muted" style="padding:14px">Sem valores nesta sess√£o.</td></tr>'}</tbody>
      </table>
    </div>`;
}

/* ======= captura / salvar ======= */
function trySave(val){
  if(!session.nominal || session.plus===null || session.minus===null || !session.partName || !session.partCode){
    alert('Preencha os campos obrigat√≥rios: Dimens√£o nominal, Toler√¢ncias, Pe√ßa e C√≥digo.');
    return;
  }
  const v = Number(val);
  if(Number.isNaN(v)) return;
  const inside = ok(v, session.lo, session.hi);
  // checagem ‚Äúmuito fora‚Äù (¬±1 do limite)
  if(!inside && (v > session.hi + 1 || v < session.lo - 1)){
    const msg = `Valor ${v} est√° muito fora dos limites (${fmt(session.lo)} a ${fmt(session.hi)}).\nDeseja registrar assim mesmo?`;
    if(!confirm(msg)) return;
  }
  session.values.push({v, ts:Date.now(), ok:inside});
  $('#last-reading').textContent = fmt(v);
  setStatus(inside?'ok':'nok', inside?'APROVADO':'REPROVADO');
  drawChart();
  renderSessionTable();
  $('#input-reading').value='';
  $('#input-reading').focus();
}

/* ======= eventos ======= */
$('#btn-save').addEventListener('click', ()=> {
  trySave( toNum($('#input-reading').value) );
});
$('#input-reading').addEventListener('keydown', (e)=>{
  if(e.key==='Enter') trySave( toNum(e.currentTarget.value) );
});
$('#btn-cancel').addEventListener('click', ()=>{
  if(!session.values.length) return;
  const last = session.values.pop();
  // Mant√©m como ‚Äúanulado‚Äù no global (se desejar), aqui removemos s√≥ do gr√°fico da sess√£o:
  setStatus('','Aguardando in√≠cio da medi√ß√£o');
  $('#last-reading').textContent = '‚Äî';
  drawChart(); renderSessionTable();
});

$('#btn-start').addEventListener('click', ()=>{
  // trava obrigat√≥rios
  session.partName = $('#partName').value.trim();
  session.partCode = $('#partCode').value.trim();
  recalcLimits();
  // foco/scroll para o painel de medi√ß√£o
  setTimeout(()=>{
    $('#panel-measure').scrollIntoView({behavior:'smooth', block:'start'});
    $('#input-reading').focus();
  }, 100);
});

$('#btn-clear').addEventListener('click', ()=>{
  // limpa toda a sess√£o
  session.values = [];
  $('#input-reading').value='';
  $('#last-reading').textContent='‚Äî';
  setStatus('','Aguardando in√≠cio da medi√ß√£o');
  drawChart(); renderSessionTable();
});

$('#btn-history').addEventListener('click', ()=> goTo('screen-history'));

/* Bluetooth (placeholder) */
$('#btn-bt').addEventListener('click', ()=>{
  alert('Conex√£o BT: em breve integra√ß√£o com Bluetooth Web.\n(placeholder)');
});

/* Hist√≥rico (mock b√°sico) */
$('#btn-export').addEventListener('click', ()=>{
  const rows = session.values.map((r,i)=>[i+1,new Date(r.ts).toISOString(), r.v, r.ok?'OK':'NOK'].join(';'));
  const csv = ['N;Data;Valor;Resultado',...rows].join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='inova-measurement.csv'; a.click();
});
$('#btn-pin').addEventListener('click', ()=>{
  const current = localStorage.getItem('pin') || '';
  const input = prompt(current ? 'Digite o novo PIN (atual: oculto)':'Defina um PIN:');
  if(input!==null){ localStorage.setItem('pin', input.trim()); alert('PIN atualizado.'); }
});
$('#btn-clear-all').addEventListener('click', ()=>{
  if(confirm('Tem certeza que deseja limpar o hist√≥rico local desta sess√£o?')){
    session.values=[]; drawChart(); renderSessionTable();
  }
});

/* inicializa√ß√£o */
goTo('screen-measure');         // abre direto a tela 2 durante desenvolvimento
setStatus('','Aguardando in√≠cio da medi√ß√£o');
renderSessionTable();
</script>
</body>
</html>
